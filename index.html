<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema de Gesti√≥n Docente</title>
  <style>
    :root{ --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#38bdf8; --good:#22c55e; --warn:#f59e0b; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0f172a);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;min-height:100dvh}
    header{padding:16px 20px;border-bottom:1px solid #1f2937;background:rgba(17,24,39,.6);backdrop-filter:saturate(140%) blur(6px);position:sticky;top:0;z-index:10;display:flex;align-items:center;gap:12px}
    header img.logo{height:44px;width:auto;object-fit:contain;border-radius:8px}
    header h1{margin:0;font-size:clamp(18px,3vw,28px)}
    main{max-width:1100px;margin:24px auto;padding:0 16px 48px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:920px){.grid{grid-template-columns:2fr 1fr}}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .pill{border:1px solid #374151;background:#0b1220;color:var(--text);padding:10px 12px;border-radius:12px}
    select, button{all:unset}
    select{cursor:pointer}
    button{cursor:pointer;display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;background:var(--accent);color:#00121c;font-weight:700}
    .hint{color:var(--muted);font-size:13px}
    table{width:100%;border-collapse:collapse}
    th, td{padding:10px 8px;border-bottom:1px solid #243244}
    th{text-align:left;color:#cbd5e1;font-size:13px}
    td{font-size:14px}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
    .kpi .box{background:#0b1220;border:1px solid #223049;border-radius:14px;padding:12px}
    .box .label{color:#a1a1aa;font-size:12px}
    .box .value{font-size:22px;font-weight:700}
    .tag{padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700}
    .prog{background:rgba(34,197,94,.15);color:var(--good);border:1px solid rgba(34,197,94,.35)}
    .extra{background:rgba(245,158,11,.15);color:var(--warn);border:1px solid rgba(245,158,11,.35)}
    .footer{margin-top:8px;font-size:12px;color:#9ca3af}
    .hidden{display:none}
    .danger{color:#fca5a5}
    .nowrap{white-space:nowrap}
  </style>
</head>
<body>
  <header>
    <img class="logo" src="./logo.png" alt="Logo Escuela" />
    <h1>Sistema de Gesti√≥n Docente</h1>
  </header>

  <main>
    <div class="grid">
      <section class="card">
        <div class="controls">
          <label class="pill">
            Docente:
            <select id="docenteSelect" title="Seleccion√° un docente" disabled></select>
          </label>
          <label class="pill">
            <input type="checkbox" id="incluyeTitular" checked> Incluir titular
          </label>
          <label class="pill">
            <input type="checkbox" id="incluyeSuplente" checked> Incluir suplente
          </label>
          <button id="descargarBtn" aria-disabled="true" title="Descargar resultados" disabled>üì• Descargar CSV</button>
        </div>
        <p class="hint">
          Fuente <b>en l√≠nea</b> (solo lectura) desde Google Sheets <i>publicado como p√°gina</i>. <br/>
          Encabezados esperados: <em>Grado</em>, <em>Materia</em>, <em>Cantidad de Hora(s)</em>, <em>Docente Titular</em>, <em>Docente Suplente</em>, <em>Tipo de hora</em>.
        </p>
        <div id="status" class="hint"></div>

        <div class="kpi">
          <div class="box"><div class="label">Total de horas</div><div id="kTotal" class="value">‚Äî</div></div>
          <div class="box"><div class="label">Program√°ticas</div><div id="kProg" class="value">‚Äî</div></div>
          <div class="box"><div class="label">Extraprogram√°ticas</div><div id="kExtra" class="value">‚Äî</div></div>
        </div>

        <div style="margin-top:16px;overflow:auto">
          <table id="tabla" class="hidden">
            <thead>
              <tr>
                <th>Grado</th>
                <th>Materia</th>
                <th class="nowrap">Cantidad de horas</th>
                <th>Tipo</th>
                <th>Rol</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="footer">Todo sucede en tu navegador. No se sube nada a servidores.</div>
      </section>

      <aside class="card">
        <h3 style="margin-top:0">Notas</h3>
        <ul>
          <li>Si la hoja no separa Titular/Suplente, usa una sola columna ¬´Docente¬ª.</li>
          <li>Para cambiar la fuente, reemplaz√° la URL en el c√≥digo.</li>
        </ul>
      </aside>
    </div>
  </main>

  <script>
    // ===== Config =====
    const SHEETS_PUBHTML = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSH2IAQDs41193q-zhgPprpLrbLgXTNem6h4vRQpgsKXZeWO2gpzSWJOQBZk2qtuua5c0aXkXAH1yoL/pubhtml";

    // ===== Helpers =====
    const normalize = (s='') => s.toString().replace(/^\\uFEFF/, '').normalize('NFD').replace(/\\p{Diacritic}/gu,'').trim();
    const normLower = (s='') => normalize(s).toLowerCase();
    const el = id => document.getElementById(id);

    const HEADER_ALIASES = {
      grado:   ['grado'],
      materia: ['materia'],
      horas:   ['cantidad de hora(s)','cantidad de horas','cantidad de hora','horas'],
      titular: ['docente titular','titular'],
      suplente:['docente suplente','suplente'],
      docente: ['docente','profesor','profesora','apellido y nombre','ap. y nom.'],
      tipo:    ['tipo de hora','tipo']
    };

    let RAW_ROWS = []; // matriz de datos crudos por √≠ndice de columnas
    let MAPPING = {};  // mapeo de claves -> √≠ndice

    function detectHeaders(headers){
      const lower = headers.map(h=>normLower(h));
      const map = {};
      for(const key in HEADER_ALIASES){
        const candidates = HEADER_ALIASES[key].map(c=>normLower(c));
        let idx = lower.findIndex(h=>candidates.includes(h));
        if(idx===-1){ idx = lower.findIndex(h=>candidates.some(c=>h.includes(c))); }
        map[key] = idx;
      }
      return map;
    }

    function parseNumber(x){
      if(x==null) return 0;
      const s = x.toString().replace(/,/g,'.').match(/-?\\d+(?:[\\.,]\\d+)?/);
      return s ? Number(s[0].replace(',','.')) : 0;
    }

    function tipoCanonico(s){
      const t = normLower(s);
      return t.includes('extra') ? 'Extraprogram√°tica' : 'Program√°tica';
    }

    function rolEnFila(row, nombre){
      const tit = MAPPING.titular!==-1 ? normLower(row[MAPPING.titular]||'') : '';
      const sup = MAPPING.suplente!==-1 ? normLower(row[MAPPING.suplente]||'') : '';
      const unico = MAPPING.docente!==-1 ? normLower(row[MAPPING.docente]||'') : '';
      const n = normLower(nombre);
      const roles = [];
      if(tit && tit.includes(n)) roles.push('Titular');
      if(sup && sup.includes(n)) roles.push('Suplente');
      if(!roles.length && unico && unico.includes(n)) roles.push('Docente');
      return roles;
    }

    function uniqueDocentes(rows){
      const set = new Set();
      rows.forEach(r=>{
        const pushName = v=>{ if(v) set.add(normalize(v)); };
        if(MAPPING.titular!==-1) pushName(r[MAPPING.titular]);
        if(MAPPING.suplente!==-1) pushName(r[MAPPING.suplente]);
        if(MAPPING.docente!==-1) pushName(r[MAPPING.docente]);
      });
      return Array.from(set).filter(Boolean).sort((a,b)=>a.localeCompare(b,'es'));
    }

    function renderDocentes(options){
      const sel = document.getElementById('docenteSelect');
      sel.innerHTML = '<option value=\"\" disabled selected>Eleg√≠ un docente‚Ä¶</option>' + options.map(o=>`<option>${o}</option>`).join('');
      sel.disabled = options.length===0;
      document.getElementById('descargarBtn').disabled = true;
    }

    function filtrarPorDocente(nombre, {inclTit, inclSup}){
      const tabla = document.getElementById('tabla');
      const body = tabla.querySelector('tbody');
      body.innerHTML = '';
      let total=0, prog=0, extra=0, rowsOut=[];

      RAW_ROWS.forEach(r=>{
        const roles = rolEnFila(r, nombre);
        const esTit = roles.includes('Titular');
        const esSup = roles.includes('Suplente');
        const esDoc = roles.includes('Docente');
        if((inclTit && esTit) || (inclSup && esSup) || esDoc){
          const grado = r[MAPPING.grado] ?? '';
          const materia = r[MAPPING.materia] ?? '';
          const horas = parseNumber(r[MAPPING.horas]);
          const tipo = tipoCanonico(r[MAPPING.tipo] ?? 'Program√°tica');
          const rol = esTit && esSup ? 'Titular y Suplente' : esTit ? 'Titular' : esSup ? 'Suplente' : 'Docente';

          total += horas;
          if(tipo.startsWith('Progr')) prog += horas; else extra += horas;

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${grado}</td>
            <td>${materia}</td>
            <td class="nowrap">${horas}</td>
            <td>${tipo === 'Program√°tica' ? `<span class="tag prog">${tipo}</span>` : `<span class="tag extra">${tipo}</span>`}</td>
            <td>${rol}</td>
          `;
          body.appendChild(tr);

          rowsOut.push({Grado:grado, Materia:materia, Horas:horas, Tipo:tipo, Rol:rol});
        }
      });

      document.getElementById('kTotal').textContent = Intl.NumberFormat('es-AR').format(total);
      document.getElementById('kProg').textContent = Intl.NumberFormat('es-AR').format(prog);
      document.getElementById('kExtra').textContent = Intl.NumberFormat('es-AR').format(extra);

      tabla.classList.toggle('hidden', body.children.length===0);

      const btn = document.getElementById('descargarBtn');
      btn.disabled = body.children.length===0;
      btn.onclick = () => descargarCSV(nombre, rowsOut, {total, prog, extra});
    }

    function descargarCSV(nombre, rows, sums){
      const encabezados = ['Docente','Grado','Materia','Horas','Tipo','Rol'];
      const data = rows.map(r=>[nombre,r.Grado,r.Materia,r.Horas,r.Tipo,r.Rol]);
      data.unshift(encabezados);
      data.push([]);
      data.push(['TOTAL','','',sums.total,'','']);
      data.push(['Programaticas','','',sums.prog,'','']);
      data.push(['Extraprogramaticas','','',sums.extra,'','']);
      const csv = data.map(row=>row.map(x=>`"${String(x??'').replace(/"/g,'""')}"`).join(',')).join('\\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `reporte_${nombre.replace(/\\s+/g,'_')}.csv`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    // --- Lectura robusta desde pubhtml ---
    async function fetchText(url){
      const res = await fetch(url, {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      return await res.text();
    }

    function extractTable(html){
      const dom = new DOMParser().parseFromString(html, 'text/html');
      let table = dom.querySelector('table.waffle'); // t√≠pico de Google Sheets
      if(!table) table = dom.querySelector('table'); // fallback
      return { table, dom };
    }

    async function cargarDesdePubHtml(url){
      try{
        el('status').textContent = 'Descargando tabla‚Ä¶';
        const html = await fetchText(url);
        let { table, dom } = extractTable(html);

        // Si no hay tabla, intentamos seguir el primer iframe
        if(!table){
          const ifr = dom.querySelector('iframe, frame');
          if(!ifr || !ifr.src) throw new Error('No encontr√© tabla en la p√°gina publicada');
          const iframeHtml = await fetchText(ifr.src);
          ({ table } = extractTable(iframeHtml));
        }

        if(!table) throw new Error('No encontr√© tabla en la p√°gina publicada');

        const rows = Array.from(table.querySelectorAll('tr'))
          .map(tr => Array.from(tr.querySelectorAll('th,td')).map(td => td.innerText.trim()));

        if(rows.length < 2) throw new Error('La tabla publicada no tiene datos suficientes');

        const headers = rows[0];
        const dataRows = rows.slice(1);
        const objects = dataRows.map(r => {
          const o = {}; headers.forEach((h,i)=> o[h] = r[i]); return o;
        });

        prepararDatos(objects, headers);
        el('status').textContent = `Tabla cargada. Filas: ${objects.length}. Encabezados: ${headers.join(' | ')}`;

      }catch(e){
        el('status').innerHTML = '<span class="danger">No pude traer la base: '+(e?.message||e)+'</span>';
      }
    }

    function prepararDatos(rows, fields){
      MAPPING = detectHeaders(fields);
      // requeridos m√≠nimos + rol (Titular/Suplente) o columna √∫nica 'Docente'
      const requiredBase = ['grado','materia','horas','tipo'];
      const requiredRol = (MAPPING.titular===-1 && MAPPING.suplente===-1) ? ['docente'] : [];
      const faltantes = [...requiredBase, ...requiredRol].filter(k=>MAPPING[k]===-1);
      if(faltantes.length){
        el('status').innerHTML = 'Encabezados faltantes o no reconocidos: <b>'+faltantes.join(', ')+'</b>.';
      }
      RAW_ROWS = rows.map(row => fields.map(h=>row[h]));
      const docentes = uniqueDocentes(RAW_ROWS);
      renderDocentes(docentes);
    }

    // === Eventos ===
    document.getElementById('docenteSelect').addEventListener('change', ()=>{
      const nombre = document.getElementById('docenteSelect').value;
      filtrarPorDocente(nombre, {inclTit: document.getElementById('incluyeTitular').checked, inclSup: document.getElementById('incluyeSuplente').checked});
    });
    ['incluyeTitular','incluyeSuplente'].forEach(id=>{
      document.getElementById(id).addEventListener('change', ()=>{
        if(!document.getElementById('docenteSelect').value) return;
        const nombre = document.getElementById('docenteSelect').value;
        filtrarPorDocente(nombre, {inclTit: document.getElementById('incluyeTitular').checked, inclSup: document.getElementById('incluyeSuplente').checked});
      });
    });

    // === Arranque ===
    window.addEventListener('DOMContentLoaded', ()=>{
      cargarDesdePubHtml(SHEETS_PUBHTML);
    });
  </script>
</body>
</html>

