<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema de Gesti√≥n Docente</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{
      --bg:#0f172a; /* slate-900 */
      --card:#111827; /* gray-900 */
      --muted:#94a3b8; /* slate-400 */
      --text:#e5e7eb; /* gray-200 */
      --accent:#38bdf8; /* sky-400 */
      --good:#22c55e; /* green-500 */
      --warn:#f59e0b; /* amber-500 */
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1220, #0f172a);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;min-height:100dvh}
    header{padding:20px 24px;border-bottom:1px solid #1f2937;background:rgba(17,24,39,0.6);backdrop-filter:saturate(140%) blur(6px);position:sticky;top:0;z-index:10}
    h1{margin:0;font-size:clamp(18px,3vw,28px);letter-spacing:.3px}
    main{max-width:1100px;margin:24px auto;padding:0 16px 48px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:920px){.grid{grid-template-columns:2fr 1fr}}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .pill{border:1px solid #374151;background:#0b1220;color:var(--text);padding:10px 12px;border-radius:12px}
    select, input[type="file"], button{all:unset}
    select, input[type="file"]{cursor:pointer}
    button{cursor:pointer;display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;background:var(--accent);color:#00121c;font-weight:700}
    .hint{color:var(--muted);font-size:13px}
    table{width:100%;border-collapse:collapse}
    th, td{padding:10px 8px;border-bottom:1px solid #243244}
    th{text-align:left;color:#cbd5e1;font-size:13px}
    td{font-size:14px}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
    .kpi .box{background:#0b1220;border:1px solid #223049;border-radius:14px;padding:12px}
    .box .label{color:#a1a1aa;font-size:12px}
    .box .value{font-size:22px;font-weight:700}
    .tag{padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700}
    .prog{background:rgba(34,197,94,.15);color:var(--good);border:1px solid rgba(34,197,94,.35)}
    .extra{background:rgba(245,158,11,.15);color:var(--warn);border:1px solid rgba(245,158,11,.35)}
    .footer{margin-top:8px;font-size:12px;color:#9ca3af}
    .hidden{display:none}
    .danger{color:#fca5a5}
    .nowrap{white-space:nowrap}
    header{display:flex;align-items:center;gap:12px}
    header .brand{display:flex;align-items:center;gap:12px}
    header img.logo{height:44px;width:auto;object-fit:contain;border-radius:8px}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img class="logo" src="./logo.png" alt="Logo Escuela" />
      <h1>Sistema de Gesti√≥n Docente</h1>
    </div>
  </header>
  <main>
    <div class="grid">
      <section class="card">
        <div class="controls">
          <label class="pill">
            Docente:
            <select id="docenteSelect" title="Seleccion√° un docente" disabled></select>
          </label>
          <label class="pill">
            <input type="checkbox" id="incluyeTitular" checked> Incluir titular
          </label>
          <label class="pill">
            <input type="checkbox" id="incluyeSuplente" checked> Incluir suplente
          </label>
          <button id="descargarBtn" aria-disabled="true" title="Descargar resultados" disabled>üì• Descargar CSV</button>
        </div>
        <p class="hint">Fuente <b>en l√≠nea</b> (solo lectura): Google Sheets publicado como CSV. La app se actualiza autom√°ticamente con la URL fijada en el c√≥digo. No hay carga manual.</p> Encabezados esperados (insensibles a may√∫sculas/acentos): <em>Grado</em>, <em>Materia</em>, <em>Cantidad de Hora(s)</em>, <em>Docente Titular</em>, <em>Docente Suplente</em>, <em>Tipo de hora</em>.</p>
        <div id="status" class="hint"></div>
        <div class="kpi">
          <div class="box"><div class="label">Total de horas</div><div id="kTotal" class="value">‚Äî</div></div>
          <div class="box"><div class="label">Program√°ticas</div><div id="kProg" class="value">‚Äî</div></div>
          <div class="box"><div class="label">Extraprogram√°ticas</div><div id="kExtra" class="value">‚Äî</div></div>
        </div>
        <div style="margin-top:16px;overflow:auto">
          <table id="tabla" class="hidden">
            <thead>
              <tr>
                <th>Grado</th>
                <th>Materia</th>
                <th class="nowrap">Cantidad de horas</th>
                <th>Tipo</th>
                <th>Rol</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="footer">Consejo: activ√° los filtros en tu sheet para chequear nombres duplicados o tildes perdidas. Ac√° normalizamos acentos y may√∫sculas para unir variantes comunes.</div>
      </section>
      <aside class="card">
        <h3 style="margin-top:0">C√≥mo usarlo</h3>
        <ol>
          <li>En Google Sheets: <em>Archivo ‚Üí Descargar ‚Üí Valores separados por comas (.csv)</em>.</li>
          <li>Carg√° el CSV con el bot√≥n de arriba.</li>
          <li>Eleg√≠ el docente. Pod√©s contar si figura como titular, suplente o ambos.</li>
          <li>Descarg√° el CSV de resultados para reportes o auditor√≠a.</li>
        </ol>
        <details>
          <summary>Estructura de columnas reconocidas</summary>
          <ul>
            <li><b>Grado</b> (o "GRADO")</li>
            <li><b>Materia</b></li>
            <li><b>Cantidad de Hora(s)</b> (se aceptan: "Cantidad", "Cant Horas", "Horas")</li>
            <li><b>Docente Titular</b></li>
            <li><b>Docente Suplente</b></li>
            <li><b>Tipo de hora</b> (detecta <i>program√°tica</i> y <i>extraprogram√°tica</i> aunque est√©n sin acentos)</li>
          </ul>
        </details>
        <p class="hint">Todo sucede en tu navegador. No se sube nada a servidores.</p>
      </aside>
    </div>
  </main>
  <script>
    // Helpers
    const normalize = (s='') => s.toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').trim();
    const normLower = (s='') => normalize(s).toLowerCase();

    const HEADER_ALIASES = {
      grado: ['grado','grados'],
      materia: ['materia','asignatura'],
      horas: ['cantidad de hora','cantidad de horas','cant horas','cantidad','horas','canti dad hora','canti\n dad\n hora','canti_dad_hora'],
      titular: ['docente titular','titular'],
      suplente: ['docente suplente','suplente'],
      tipo: ['tipo de hora','tipo','modalidad']
    };

    let RAW_ROWS = [];
    let MAPPING = {};

    const el = id => document.getElementById(id);
    const SHEETS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSH2IAQDs41193q-zhgPprpLrbLgXTNem6h4vRQpgsKXZeWO2gpzSWJOQBZk2qtuua5c0aXkXAH1yoL/pub?gid=300900649&single=true&output=csv";
    
    function cargarDesdeObjetos(rows, fields)(rows, fields){
      MAPPING = detectHeaders(fields);
      const required = ['grado','materia','horas','titular','suplente','tipo'];
      const faltantes = required.filter(k=>MAPPING[k]===-1);
      if(faltantes.length){
        el('status').innerHTML = 'Encabezados faltantes o no reconocidos: <b>'+faltantes.join(', ')+'</b>.';
      } else {
        el('status').textContent = '';
      }
      RAW_ROWS = rows.map(row => fields.map(h=>row[h]));
      const docentes = uniqueDocentes(RAW_ROWS);
      renderDocentes(docentes);
      el('status').textContent = `Datos listos. Docentes detectados: ${docentes.length}.`;
    }

    
        },
        error: (err)=>{
          el('status').innerHTML = '<span class="danger">Error al leer el CSV: '+(err?.message||err)+'</span>';
        }
      });
    });

    // Auto-carga al abrir con la URL fija
    window.addEventListener('DOMContentLoaded', ()=>{
      cargarDesdeURL(SHEETS_CSV_URL);
    });
      if(u) cargarDesdeURL(u);
    });

    docenteSelect.addEventListener('change', ()=>{
      const nombre = docenteSelect.value;
      filtrarPorDocente(nombre, {inclTit: el('incluyeTitular').checked, inclSup: el('incluyeSuplente').checked});
    });

    ['incluyeTitular','incluyeSuplente'].forEach(id=>{
      el(id).addEventListener('change', ()=>{
        if(!docenteSelect.value) return;
        const nombre = docenteSelect.value;
        filtrarPorDocente(nombre, {inclTit: el('incluyeTitular').checked, inclSup: el('incluyeSuplente').checked});
      });
    });
  </script>
</body>
</html>
