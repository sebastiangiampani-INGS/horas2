<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema de Gesti√≥n Docente</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <!-- IMPORTANTE: este script SOLO carga la librer√≠a; no pongas c√≥digo adentro -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{ --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#38bdf8; --good:#22c55e; --warn:#f59e0b; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0f172a);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;min-height:100dvh}
    header{padding:16px 20px;border-bottom:1px solid #1f2937;background:rgba(17,24,39,.6);backdrop-filter:saturate(140%) blur(6px);position:sticky;top:0;z-index:10;display:flex;gap:12px;align-items:center}
    header img.logo{height:44px;border-radius:8px}
    header h1{margin:0;font-size:clamp(18px,3vw,28px)}
    main{max-width:1100px;margin:24px auto;padding:0 16px 48px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:920px){.grid{grid-template-columns:2fr 1fr}}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:16px}
    .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .pill{border:1px solid #374151;background:#0b1220;color:var(--text);padding:10px 12px;border-radius:12px;display:flex;gap:8px;align-items:center}
    select,button{all:unset} select{cursor:pointer}
    button{cursor:pointer;padding:10px 14px;border-radius:12px;background:var(--accent);color:#00121c;font-weight:700}
    .hint{color:var(--muted);font-size:13px}
    table{width:100%;border-collapse:collapse} th,td{padding:10px 8px;border-bottom:1px solid #243244}
    th{color:#cbd5e1;font-size:13px;text-align:left} td{font-size:14px}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
    .kpi .box{background:#0b1220;border:1px solid #223049;border-radius:14px;padding:12px}
    .box .label{color:#a1a1aa;font-size:12px} .box .value{font-size:22px;font-weight:700}
    .tag{padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700}
    .prog{background:rgba(34,197,94,.15);color:var(--good);border:1px solid rgba(34,197,94,.35)}
    .extra{background:rgba(245,158,11,.15);color:var(--warn);border:1px solid rgba(245,158,11,.35)}
    .hidden{display:none} .nowrap{white-space:nowrap} .danger{color:#fca5a5}
  </style>
</head>
<body>
  <header>
    <img class="logo" src="./logo.png" alt="Logo Escuela">
    <h1>Sistema de Gesti√≥n Docente</h1>
  </header>

  <main>
    <div class="grid">
      <section class="card">
        <div class="controls">
          <label class="pill">Docente:
            <select id="docenteSelect" disabled></select>
          </label>
          <label class="pill"><input type="checkbox" id="incluyeTitular" checked> Incluir titular</label>
          <label class="pill"><input type="checkbox" id="incluyeSuplente" checked> Incluir suplente</label>
          <button id="descargarBtn" disabled>üì• Descargar CSV</button>
        </div>

        <p class="hint">
          Lee en vivo desde Google Sheets publicado como <b>CSV</b> (solo lectura).<br>
          Encabezados esperados: <em>Sala/ Grado/ A√±o /Cargo</em>, <em>Materia</em>, <em>Cantidad Horas</em>,
          <em>Docente Titular</em>, <em>Docente Suplente</em>, <em>Tipo de hora</em>, <em>%Antiguedad</em> (opcional).
        </p>
        <div id="status" class="hint"></div>

        <div class="kpi">
          <div class="box"><div class="label">Total de horas</div><div id="kTotal" class="value">‚Äî</div></div>
          <div class="box"><div class="label">Program√°ticas</div><div id="kProg" class="value">‚Äî</div></div>
          <div class="box"><div class="label">Extraprogram√°ticas</div><div id="kExtra" class="value">‚Äî</div></div>
        </div>

        <div style="margin-top:16px;overflow:auto">
          <table id="tabla" class="hidden">
            <thead>
              <tr>
                <th>Grado</th>
                <th>Materia</th>
                <th class="nowrap">Cantidad de horas</th>
                <th>% Antig√ºedad</th>
                <th>Tipo</th>
                <th>Rol</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <aside class="card">
        <h3 style="margin-top:0">Notas</h3>
        <ul>
          <li>El combo se arma con <b>Docente Titular</b> y <b>Docente Suplente</b> (o <b>Docente</b>, si existe).</li>
          <li>%Antig√ºedad se muestra <b>tal cual</b> viene del sheet.</li>
        </ul>
      </aside>
    </div>
  </main>

  <script>
    // URL de tu sheet p√∫blico en CSV
    const SHEETS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTscmx2DEPC37LAgT69CQUDHx-5U6aLo6dGFzMQGEBoM20Qw9ZJuSj_HzR-kt2CzkKKeBvUXzwiYJyO/pub?gid=300900649&single=true&output=csv";

    // Utilidades
    const el = id => document.getElementById(id);
    const normalize = s => s?.toString().replace(/^\uFEFF/,'').trim() ?? '';
    const toNum = x => {
      if(x==null || x==='') return 0;
      const m = x.toString().replace(/,/g,'.').match(/-?\d+(?:[.,]\d+)?/);
      return m ? Number(m[0].replace(',','.')) : 0;
    };
    const fmt = n => Intl.NumberFormat('es-AR').format(n||0);

    // Detecci√≥n robusta de encabezados
    const HDRS = {
      grado:   ['sala/ grado/ a√±o /cargo','sala/ grado/ a√±o/cargo','grado','curso','a√±o','anio','nivel'],
      materia: ['materia','asignatura','espacio curricular','area','√°rea'],
      horas:   ['cantidad horas','cantidad de hora(s)','cantidad de horas','cantidad de hora','cant horas','horas','carga horaria','hs'],
      titular: ['docente titular','titular'],
      suplente:['docente suplente','suplente'],
      docente: ['docente','profesor','profesora','apellido y nombre','ap. y nom.','nombre docente'],
      tipo:    ['tipo de hora','tipo','modalidad','caracter','car√°cter','programatica','program√°tica','extraprogramatica','extraprogram√°tica'],
      antig:   ['%antiguedad','% antiguedad','% antig√ºedad','antig√ºedad (%)','antiguedad (%)','antig√ºedad','antiguedad','antig.']
    };

    let RAW = [];   // filas como arrays
    let MAP = {};   // clave -> √≠ndice

    const low = s => normalize(s).toLowerCase();
    function detectHeaders(headers){
      const lower = headers.map(h=>low(h));
      const map = {};
      for(const key in HDRS){
        const cands = HDRS[key].map(low);
        let idx = lower.findIndex(h => cands.includes(h));
        if(idx===-1) idx = lower.findIndex(h => cands.some(c => h.includes(c)));
        map[key] = idx; // -1 si no est√°
      }
      return map;
    }

    function buildDocentes(rows){
      const set = new Set();
      rows.forEach(r=>{
        const push = v => { const t = normalize(v); if(t) set.add(t); };
        if(MAP.titular!==-1) push(r[MAP.titular]);
        if(MAP.suplente!==-1) push(r[MAP.suplente]);
        if(MAP.docente !==-1) push(r[MAP.docente ]);
      });
      return Array.from(set).filter(Boolean).sort((a,b)=>a.localeCompare(b,'es'));
    }

    function renderDocentes(list){
      const sel = el('docenteSelect');
      sel.innerHTML = '<option value="" selected disabled>Eleg√≠ un docente‚Ä¶</option>' + list.map(n=>`<option>${n}</option>`).join('');
      sel.disabled = list.length===0;
      el('descargarBtn').disabled = true;
    }

    function tipoCanonico(s){ return low(s).includes('extra') ? 'Extraprogram√°tica' : 'Program√°tica'; }

    function rolesDeFila(row, nombre){
      const tit = MAP.titular!==-1 ? normalize(row[MAP.titular]) : '';
      const sup = MAP.suplente!==-1 ? normalize(row[MAP.suplente]) : '';
      const uno = MAP.docente !==-1 ? normalize(row[MAP.docente ]) : '';
      const roles = [];
      if(tit === nombre) roles.push('Titular');
      if(sup === nombre) roles.push('Suplente');
      if(!roles.length && uno === nombre) roles.push('Docente');
      return roles;
    }

    function filtrar(nombre, {tit, sup}){
      const body = el('tabla').querySelector('tbody');
      body.innerHTML = '';
      let total=0, prog=0, extra=0;
      const out=[];

      RAW.forEach(r=>{
        const roles = rolesDeFila(r, nombre);
        const esTit = roles.includes('Titular');
        const esSup = roles.includes('Suplente');
        const esDoc = roles.includes('Docente');
        if((tit && esTit) || (sup && esSup) || esDoc){
          const grado   = r[MAP.grado] ?? '';
          const materia = r[MAP.materia] ?? '';
          const horas   = toNum(r[MAP.horas]);
          const tipo    = tipoCanonico(r[MAP.tipo] ?? 'Program√°tica');
          const rol     = esTit && esSup ? 'Titular y Suplente' : esTit ? 'Titular' : esSup ? 'Suplente' : 'Docente';
          const antig   = MAP.antig!==-1 ? (r[MAP.antig] ?? '') : '';

          total += horas; (tipo.startsWith('Progr') ? (prog+=horas) : (extra+=horas));

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${grado}</td>
            <td>${materia}</td>
            <td class="nowrap">${horas}</td>
            <td class="nowrap">${antig}</td>
            <td>${tipo==='Program√°tica' ? '<span class="tag prog">Program√°tica</span>' : '<span class="tag extra">Extraprogram√°tica</span>'}</td>
            <td>${rol}</td>`;
          body.appendChild(tr);

          out.push({Grado:grado,Materia:materia,Horas:horas,Antiguedad:antig,Tipo:tipo,Rol:rol});
        }
      });

      el('kTotal').textContent = fmt(total);
      el('kProg').textContent  = fmt(prog);
      el('kExtra').textContent = fmt(extra);
      el('tabla').classList.toggle('hidden', body.children.length===0);

      const btn = el('descargarBtn');
      btn.disabled = body.children.length===0;
      btn.onclick = ()=>{
        const headers = ['Docente','Grado','Materia','Horas','%Antiguedad','Tipo','Rol'];
        const rows = out.map(r=>[nombre,r.Grado,r.Materia,r.Horas,r.Antiguedad,r.Tipo,r.Rol]);
        rows.unshift(headers);
        const csv = rows.map(a=>a.map(x=>`"${String(x??'').replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob); const a=document.createElement('a');
        a.href=url; a.download=`reporte_${nombre.replace(/\s+/g,'_')}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      };
    }

    async function cargarCSV(url){
      el('status').textContent = 'Descargando CSV‚Ä¶';
      const res = await fetch(url,{cache:'no-store'});
      if(!res.ok){ el('status').innerHTML = '<span class="danger">HTTP '+res.status+'</span>'; return; }
      const txt = await res.text();

      // 1) Parse con header:true
      let p = Papa.parse(txt,{header:true, skipEmptyLines:true, delimiter:'auto'});
      let fields = p?.meta?.fields || [];
      let rows   = p?.data || [];

      // 2) Fallback si viniera sin encabezados
      if(!fields.length){
        const p2 = Papa.parse(txt,{header:false, skipEmptyLines:true, delimiter:'auto'});
        if(Array.isArray(p2.data) && p2.data.length>1){
          const hdrs = p2.data[0].map(x=>String(x||'')); fields = hdrs;
          rows = p2.data.slice(1).map(arr=>{ const o={}; hdrs.forEach((h,i)=>o[h]=arr[i]); return o; });
        }
      }
      if(!fields.length){ el('status').innerHTML = '<span class="danger">No pude leer encabezados.</span>'; return; }

      MAP = detectHeaders(fields);
      RAW = rows.map(row => fields.map(h => row[h]));

      const docentes = buildDocentes(RAW);
      renderDocentes(docentes);
      el('status').textContent = `CSV cargado. Filas: ${rows.length}. Docentes: ${docentes.length}.`;
    }

    // Eventos
    el('docenteSelect').addEventListener('change', ()=>{
      const nombre = el('docenteSelect').value;
      if(!nombre) return;
      filtrar(nombre, {tit: el('incluyeTitular').checked, sup: el('incluyeSuplente').checked});
    });
    ['incluyeTitular','incluyeSuplente'].forEach(id=>{
      el(id).addEventListener('change', ()=>{
        const n = el('docenteSelect').value;
        if(n) filtrar(n, {tit: el('incluyeTitular').checked, sup: el('incluyeSuplente').checked});
      });
    });

    // Arranque
    window.addEventListener('DOMContentLoaded', ()=>{ cargarCSV(SHEETS_CSV_URL); });
  </script>
</body>
</html>
